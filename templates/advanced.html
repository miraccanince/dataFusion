<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Comparison Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            color: #333;
            padding: 20px;
        }
        .container { max-width: 1600px; margin: 0 auto; }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .card h2 {
            color: #4299e1;
            margin-bottom: 15px;
            border-bottom: 2px solid #4299e1;
            padding-bottom: 10px;
        }

        .comparison-chart { height: 300px; margin-top: 15px; }
        .trajectory-chart { height: 500px; }

        .algorithm-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .btn-naive { background: #fc8181; color: white; }
        .btn-naive:hover { background: #f56565; }
        .btn-naive.active { background: #c53030; box-shadow: 0 0 10px #fc8181; }

        .btn-bayesian { background: #63b3ed; color: white; }
        .btn-bayesian:hover { background: #4299e1; }
        .btn-bayesian.active { background: #2b6cb0; box-shadow: 0 0 10px #63b3ed; }

        .btn-particle { background: #68d391; color: white; }
        .btn-particle:hover { background: #48bb78; }
        .btn-particle.active { background: #2f855a; box-shadow: 0 0 10px #68d391; }

        .btn-all { background: #9f7aea; color: white; }
        .btn-all:hover { background: #805ad5; }

        .btn-reset { background: #f56565; color: white; }
        .btn-download { background: #ed8936; color: white; }

        .error-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .metric-label { font-size: 12px; opacity: 0.9; }
        .metric-value { font-size: 24px; font-weight: bold; margin-top: 5px; }

        .parameter-slider {
            margin: 15px 0;
        }

        .parameter-slider label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        input[type="range"] {
            width: 100%;
            margin: 5px 0;
        }

        .slider-value {
            display: inline-block;
            background: #4299e1;
            color: white;
            padding: 3px 10px;
            border-radius: 3px;
            font-size: 12px;
            margin-left: 10px;
        }

        .comparison-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .toggle-btn {
            flex: 1;
            padding: 10px;
            background: #e2e8f0;
            border: 2px solid #cbd5e0;
            color: #2d3748;
        }

        .toggle-btn.active {
            background: #4299e1;
            border-color: #3182ce;
            color: white;
        }

        .ground-truth-input {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 10px;
            margin-top: 15px;
        }

        input[type="number"] {
            padding: 8px;
            border: 2px solid #cbd5e0;
            border-radius: 5px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî¨ Advanced Comparison Dashboard</h1>

        <!-- Auto-Walk Control -->
        <div class="card" id="autoWalkCard" style="border: 3px solid #48bb78;">
            <h2>üö∂ Auto-Walk Mode (Real-Time Detection)</h2>
            <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 15px;">
                <button id="startWalkBtn" class="btn-bayesian" onclick="startAutoWalk()" style="flex: 1; font-size: 16px;">
                    ‚ñ∂Ô∏è Start Walking
                </button>
                <button id="stopWalkBtn" class="btn-reset" onclick="stopAutoWalk()" style="flex: 1; font-size: 16px;" disabled>
                    ‚è∏Ô∏è Stop Walking
                </button>
            </div>
            <div id="walkStatus" style="text-align: center; padding: 15px; background: #f7fafc; border-radius: 8px;">
                <div style="font-size: 20px; font-weight: bold; color: #718096;">
                    Status: <span id="walkStatusText">Stopped</span>
                </div>
                <div style="margin-top: 10px; font-size: 14px; color: #4a5568;">
                    <strong>Instructions:</strong> Put Raspberry Pi in backpack, click "Start Walking", then walk naturally.
                    Your position will update automatically with each stride!
                </div>
            </div>
        </div>

        <!-- Manual Algorithm Selection (Fallback) -->
        <div class="card">
            <h2>üéØ Manual Mode (Button Triggered)</h2>
            <div class="algorithm-selector">
                <button class="btn-naive" onclick="selectAlgorithm('naive')">
                    üìä Naive Dead Reckoning
                </button>
                <button class="btn-bayesian" onclick="selectAlgorithm('bayesian')">
                    üßÆ Bayesian Filter
                </button>
                <button class="btn-particle" onclick="selectAlgorithm('particle')">
                    ‚öõÔ∏è Particle Filter
                </button>
                <button class="btn-all" onclick="recordAllAlgorithms()">
                    ‚ú® Record All
                </button>
            </div>
            <div style="text-align: center; margin-top: 10px;">
                <span style="font-size: 18px; font-weight: bold;">
                    Current: <span id="currentAlgo">naive</span>
                </span>
                <span style="margin-left: 20px;">
                    Strides: <span id="strideCount">0</span>
                </span>
            </div>
        </div>

        <div class="grid">
            <!-- Raw vs Filtered Comparison -->
            <div class="card">
                <h2>üìà Raw vs Filtered Sensors</h2>
                <div class="comparison-toggle">
                    <button class="toggle-btn active" onclick="showComparison('yaw')">
                        Yaw (Heading)
                    </button>
                    <button class="toggle-btn" onclick="showComparison('accel')">
                        Acceleration
                    </button>
                </div>
                <canvas id="comparisonChart" class="comparison-chart"></canvas>
                <p style="margin-top: 10px; font-size: 13px; color: #666;">
                    <strong>Blue</strong> = Raw | <strong>Green</strong> = Filtered (Kalman)
                </p>
            </div>

            <!-- Error Metrics -->
            <div class="card">
                <h2>üìè Error Metrics (vs Ground Truth)</h2>
                <div class="error-metrics">
                    <div class="metric-card" style="background: linear-gradient(135deg, #fc8181, #f56565);">
                        <div class="metric-label">Naive Error</div>
                        <div class="metric-value" id="errorNaive">--</div>
                    </div>
                    <div class="metric-card" style="background: linear-gradient(135deg, #63b3ed, #4299e1);">
                        <div class="metric-label">Bayesian Error</div>
                        <div class="metric-value" id="errorBayesian">--</div>
                    </div>
                    <div class="metric-card" style="background: linear-gradient(135deg, #68d391, #48bb78);">
                        <div class="metric-label">Particle Error</div>
                        <div class="metric-value" id="errorParticle">--</div>
                    </div>
                </div>

                <h3 style="margin-top: 20px; color: #555;">Set Ground Truth Position</h3>
                <div class="ground-truth-input">
                    <input type="number" id="gtX" placeholder="X position (m)" step="0.1">
                    <input type="number" id="gtY" placeholder="Y position (m)" step="0.1">
                    <button class="btn-bayesian" onclick="setGroundTruth()">‚úì Set</button>
                </div>
            </div>

            <!-- Parameter Tuning -->
            <div class="card">
                <h2>‚öôÔ∏è Algorithm Parameters</h2>

                <div class="parameter-slider">
                    <label>
                        Stride Length:
                        <span class="slider-value" id="strideLengthValue">0.7 m</span>
                    </label>
                    <input type="range" id="strideLength" min="0.3" max="1.2" step="0.05" value="0.7"
                           oninput="updateParameter('stride')">
                </div>

                <div class="parameter-slider">
                    <label>
                        Kalman Process Noise (Q):
                        <span class="slider-value" id="kalmanQValue">0.01</span>
                    </label>
                    <input type="range" id="kalmanQ" min="0.001" max="0.1" step="0.001" value="0.01"
                           oninput="updateParameter('kalman_Q')">
                </div>

                <div class="parameter-slider">
                    <label>
                        Kalman Measurement Noise (R):
                        <span class="slider-value" id="kalmanRValue">0.1</span>
                    </label>
                    <input type="range" id="kalmanR" min="0.01" max="1.0" step="0.01" value="0.1"
                           oninput="updateParameter('kalman_R')">
                </div>

                <p style="margin-top: 15px; padding: 10px; background: #f7fafc; border-radius: 5px; font-size: 13px;">
                    <strong>üí° Tip:</strong> Lower Q = Trust model more. Lower R = Trust measurements more.
                </p>
            </div>
        </div>

        <!-- Trajectory Comparison -->
        <div class="card">
            <h2>üó∫Ô∏è Trajectory Comparison (All Algorithms)</h2>
            <canvas id="trajectoryChart" class="trajectory-chart"></canvas>
            <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center;">
                <button class="btn-reset" onclick="resetAll()">üîÑ Reset All</button>
                <button class="btn-download" onclick="downloadData('naive')">üíæ Download Naive</button>
                <button class="btn-download" onclick="downloadData('bayesian')">üíæ Download Bayesian</button>
                <button class="btn-download" onclick="downloadData('particle')">üíæ Download Particle</button>
            </div>
        </div>
    </div>

    <script>
        let currentAlgorithm = 'naive';
        let comparisonChart, trajectoryChart;
        let comparisonMode = 'yaw';

        // Initialize charts
        function initCharts() {
            // Comparison chart
            const ctx1 = document.getElementById('comparisonChart').getContext('2d');
            comparisonChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Raw',
                            data: [],
                            borderColor: '#4299e1',
                            backgroundColor: 'rgba(66, 153, 225, 0.1)',
                            borderWidth: 2,
                            pointRadius: 0
                        },
                        {
                            label: 'Filtered',
                            data: [],
                            borderColor: '#48bb78',
                            backgroundColor: 'rgba(72, 187, 120, 0.1)',
                            borderWidth: 2,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    scales: {
                        x: { display: false },
                        y: { title: { display: true, text: 'Yaw (degrees)' } }
                    }
                }
            });

            // Trajectory chart
            const ctx2 = document.getElementById('trajectoryChart').getContext('2d');
            trajectoryChart = new Chart(ctx2, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: 'Naive DR',
                            data: [{x: 0, y: 0}],
                            backgroundColor: '#fc8181',
                            borderColor: '#f56565',
                            showLine: true,
                            pointRadius: 5
                        },
                        {
                            label: 'Bayesian Filter',
                            data: [{x: 0, y: 0}],
                            backgroundColor: '#63b3ed',
                            borderColor: '#4299e1',
                            showLine: true,
                            pointRadius: 5
                        },
                        {
                            label: 'Particle Filter',
                            data: [{x: 0, y: 0}],
                            backgroundColor: '#68d391',
                            borderColor: '#48bb78',
                            showLine: true,
                            pointRadius: 5
                        },
                        {
                            label: 'Ground Truth',
                            data: [],
                            backgroundColor: '#ffd700',
                            borderColor: '#ffa500',
                            showLine: false,
                            pointRadius: 8,
                            pointStyle: 'star'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: 'X Position (m)' } },
                        y: { title: { display: true, text: 'Y Position (m)' } }
                    }
                }
            });
        }

        function selectAlgorithm(algo) {
            currentAlgorithm = algo;
            document.getElementById('currentAlgo').textContent = algo;

            // Update button styles
            document.querySelectorAll('.algorithm-selector button').forEach(btn => {
                btn.classList.remove('active');
            });
        }

        function recordAllAlgorithms() {
            ['naive', 'bayesian', 'particle'].forEach(algo => {
                fetch(`/api/stride/${algo}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ use_filtered: algo !== 'naive' })
                });
            });
            setTimeout(updateTrajectories, 500);
        }

        function updateComparison() {
            fetch('/api/sensors/comparison')
                .then(r => r.json())
                .then(data => {
                    if (data.filtered_buffer.length > 0) {
                        const labels = data.filtered_buffer.map((_, i) => i);
                        const rawData = data.filtered_buffer.map(d => d.yaw_raw);
                        const filteredData = data.filtered_buffer.map(d => d.yaw_filtered);

                        comparisonChart.data.labels = labels;
                        comparisonChart.data.datasets[0].data = rawData;
                        comparisonChart.data.datasets[1].data = filteredData;
                        comparisonChart.update();
                    }
                });
        }

        function updateTrajectories() {
            fetch('/api/trajectories')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('strideCount').textContent = data.stride_count;

                    // Update trajectory chart
                    trajectoryChart.data.datasets[0].data = data.naive.map(p => ({x: p.x, y: p.y}));
                    trajectoryChart.data.datasets[1].data = data.bayesian.map(p => ({x: p.x, y: p.y}));
                    trajectoryChart.data.datasets[2].data = data.particle.map(p => ({x: p.x, y: p.y}));
                    trajectoryChart.data.datasets[3].data = data.ground_truth.map(p => ({x: p.x, y: p.y}));
                    trajectoryChart.update();
                });
        }

        function updateErrors() {
            fetch('/api/errors')
                .then(r => r.json())
                .then(data => {
                    if (data.naive) {
                        document.getElementById('errorNaive').textContent = data.naive.distance_error + ' m';
                    }
                    if (data.bayesian) {
                        document.getElementById('errorBayesian').textContent = data.bayesian.distance_error + ' m';
                    }
                    if (data.particle) {
                        document.getElementById('errorParticle').textContent = data.particle.distance_error + ' m';
                    }
                })
                .catch(() => {});
        }

        function setGroundTruth() {
            const x = parseFloat(document.getElementById('gtX').value);
            const y = parseFloat(document.getElementById('gtY').value);

            if (isNaN(x) || isNaN(y)) {
                alert('Please enter valid coordinates');
                return;
            }

            fetch('/api/ground_truth', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ x, y, note: 'Manual entry' })
            }).then(() => {
                updateTrajectories();
                updateErrors();
            });
        }

        function updateParameter(type) {
            let params = {};

            if (type === 'stride') {
                const val = document.getElementById('strideLength').value;
                document.getElementById('strideLengthValue').textContent = val + ' m';
                params.stride_length = val;
            } else if (type === 'kalman_Q') {
                const val = document.getElementById('kalmanQ').value;
                document.getElementById('kalmanQValue').textContent = val;
                params.kalman_Q = val;
            } else if (type === 'kalman_R') {
                const val = document.getElementById('kalmanR').value;
                document.getElementById('kalmanRValue').textContent = val;
                params.kalman_R = val;
            }

            fetch('/api/parameters', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(params)
            });
        }

        function resetAll() {
            if (confirm('Reset all data?')) {
                fetch('/api/reset', { method: 'POST' })
                    .then(() => {
                        trajectoryChart.data.datasets.forEach(ds => {
                            if (ds.label !== 'Ground Truth') ds.data = [{x: 0, y: 0}];
                            else ds.data = [];
                        });
                        trajectoryChart.update();
                        updateTrajectories();
                    });
            }
        }

        function downloadData(algo) {
            window.location.href = `/api/download/${algo}`;
        }

        function startAutoWalk() {
            fetch('/api/auto_walk/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('startWalkBtn').disabled = true;
                    document.getElementById('stopWalkBtn').disabled = false;
                    document.getElementById('walkStatusText').textContent = 'WALKING üö∂';
                    document.getElementById('walkStatusText').style.color = '#48bb78';
                    document.getElementById('autoWalkCard').style.borderColor = '#48bb78';
                    document.getElementById('autoWalkCard').style.background = '#f0fff4';
                    alert('‚úì Auto-walk started! Start walking naturally.');
                } else {
                    alert('Failed to start auto-walk: ' + data.message);
                }
            })
            .catch(err => alert('Error starting auto-walk: ' + err));
        }

        function stopAutoWalk() {
            fetch('/api/auto_walk/stop', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('startWalkBtn').disabled = false;
                    document.getElementById('stopWalkBtn').disabled = true;
                    document.getElementById('walkStatusText').textContent = 'Stopped';
                    document.getElementById('walkStatusText').style.color = '#718096';
                    document.getElementById('autoWalkCard').style.borderColor = '#48bb78';
                    document.getElementById('autoWalkCard').style.background = 'white';
                    alert('‚úì Auto-walk stopped.');
                } else {
                    alert('Failed to stop auto-walk: ' + data.message);
                }
            })
            .catch(err => alert('Error stopping auto-walk: ' + err));
        }

        function updateAutoWalkStatus() {
            fetch('/api/auto_walk/status')
                .then(r => r.json())
                .then(data => {
                    if (data.active) {
                        document.getElementById('walkStatusText').textContent = 'WALKING üö∂';
                        document.getElementById('walkStatusText').style.color = '#48bb78';
                    } else {
                        document.getElementById('walkStatusText').textContent = 'Stopped';
                        document.getElementById('walkStatusText').style.color = '#718096';
                    }
                })
                .catch(() => {});
        }

        // Auto-update
        setInterval(updateComparison, 1000);
        setInterval(updateTrajectories, 2000);
        setInterval(updateErrors, 3000);
        setInterval(updateAutoWalkStatus, 1000);  // Check walk status every second

        // Keyboard shortcut for stride recording
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                e.preventDefault();
                recordAllAlgorithms();
            }
        });

        // Initialize
        window.onload = function() {
            initCharts();
            updateComparison();
            updateTrajectories();
        };
    </script>
</body>
</html>
